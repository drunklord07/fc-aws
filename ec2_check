#!/usr/bin/env bash
# EC2 Public Subnet Audit (parallel + progress bar; AWS CLI only)
# Rule: NOT_COMPLIANT if subnet's route table has igw-* OR 0.0.0.0/0; else COMPLIANT.
# Output: summary counts (no per-instance prints).

set -u
export AWS_PAGER=""

# -------- Colors --------
BOLD=$'\033[1m'; DIM=$'\033[2m'; RESET=$'\033[0m'
GREEN=$'\033[32m'; RED=$'\033[31m'; YELLOW=$'\033[33m'

hr(){ local w; w=$(tput cols 2>/dev/null || echo 80); printf '%*s\n' "$w" '' | tr ' ' '-'; }
need(){ command -v "$1" >/dev/null 2>&1 || { echo "Missing dependency: $1"; exit 1; }; }
need aws
need awk

JOBS="${JOBS:-16}"               # override: JOBS=24 ./ec2_check.sh --all
[[ "$JOBS" =~ ^[0-9]+$ ]] || JOBS=16
(( JOBS < 1 )) && JOBS=1

# -------- Region resolution --------
REGION_ARG="${1:-}"
if [ "$REGION_ARG" = "--all" ]; then
  REGIONS="$(aws ec2 describe-regions --query 'Regions[].RegionName' --output text 2>/dev/null)"
elif [ -n "$REGION_ARG" ]; then
  REGIONS="$REGION_ARG"
else
  DEFREG="$(aws configure get region 2>/dev/null || true)"
  if [ -n "$DEFREG" ]; then REGIONS="$DEFREG"
  else REGIONS="$(aws ec2 describe-regions --query 'Regions[].RegionName' --output text 2>/dev/null)"
  fi
fi
[ -z "${REGIONS:-}" ] && { echo "No regions resolved. Set a default region or pass one/--all."; exit 1; }

ACCOUNT="$(aws sts get-caller-identity --query 'Account' --output text 2>/dev/null || echo UNKNOWN)"
ARN="$(aws sts get-caller-identity --query 'Arn' --output text 2>/dev/null || echo UNKNOWN)"

# -------- Temp files & cleanup --------
TMP_INST="$(mktemp -t ec2_inst.XXXXXX)"
TMP_RES="$(mktemp -t ec2_res.XXXXXX)"
trap 'rm -f "$TMP_INST" "$TMP_RES" 2>/dev/null || true' EXIT

# -------- Collect all instances (region, iid, subnet, vpc) --------
for REGION in $REGIONS; do
  aws ec2 describe-instances --region "$REGION" \
    --query 'Reservations[].Instances[].[InstanceId, SubnetId, VpcId]' \
    --output text 2>/dev/null \
    | awk -v r="$REGION" 'NF{ printf "%s\t%s\t%s\t%s\n", r,$1,$2,$3 }' >> "$TMP_INST"
done

TOTAL="$(wc -l < "$TMP_INST" 2>/dev/null | tr -d ' ')"
TOTAL="${TOTAL:-0}"

echo
echo "${BOLD}EC2 Public Subnet Audit${RESET}"
echo "Account: ${BOLD}$ACCOUNT${RESET}"
echo "Caller : ${DIM}$ARN${RESET}"
echo "Regions: ${BOLD}$REGIONS${RESET}"
hr

if [ "$TOTAL" -eq 0 ]; then
  echo "${YELLOW}No EC2 instances found (or no permission) in the selected scope.${RESET}"
  hr
  echo "${BOLD}Summary${RESET}"
  printf "Total instances  : 0\nChecked          : 0\n  ${GREEN}Compliant${RESET}       : 0 (0.0%%)\n  ${RED}Not compliant${RESET}    : 0 (0.0%%)\nSkipped          : 0\n"
  hr
  echo "${DIM}Rule: NOT_COMPLIANT if RouteTable has igw-* or 0.0.0.0/0; otherwise COMPLIANT.${RESET}"
  exit 0
fi

# -------- Progress bar --------
draw_progress() {
  # args: done total
  local done="$1" total="$2" cols barw filled empty pct
  cols="$(tput cols 2>/dev/null || echo 80)"
  barw=$(( cols - 36 )); [ "$barw" -lt 10 ] && barw=10
  if [ "$total" -gt 0 ]; then
    filled=$(( done * barw / total ))
  else
    filled=0
  fi
  [ "$filled" -lt 0 ] && filled=0
  [ "$filled" -gt "$barw" ] && filled="$barw"
  empty=$(( barw - filled ))
  if [ "$total" -gt 0 ]; then
    pct=$(( done * 100 / total ))
  else
    pct=0
  fi
  printf "\rProcessing: ["
  if [ "$filled" -gt 0 ]; then
    for ((i=0;i<filled;i++)); do printf "#"; done
  fi
  if [ "$empty" -gt 0 ]; then
    for ((i=0;i<empty;i++)); do printf "-"; done
  fi
  printf "] %3d%% (%d/%d)" "$pct" "$done" "$total"
}

# -------- Concurrency semaphore (portable) --------
SEM="$(mktemp -u)"; mkfifo "$SEM"
exec 3<>"$SEM"; rm -f "$SEM"
for ((k=0; k<JOBS; k++)); do echo >&3; done

# -------- Worker: check one instance --------
check_one() {
  local region="$1" iid="$2" subnet="$3" vpc="$4"
  # No subnet? skip.
  if [ -z "$subnet" ] || [ "$subnet" = "None" ]; then
    printf "SKIPPED\t%s\t%s\n" "$region" "$iid" >> "$TMP_RES"
    return
  fi

  # Find route table: subnet assoc â†’ else VPC main
  local rtb
  rtb="$(aws ec2 describe-route-tables --region "$region" \
        --filters "Name=association.subnet-id,Values=$subnet" \
        --query 'RouteTables[0].RouteTableId' --output text 2>/dev/null)"
  if [ -z "$rtb" ] || [ "$rtb" = "None" ]; then
    rtb="$(aws ec2 describe-route-tables --region "$region" \
          --filters "Name=vpc-id,Values=$vpc" "Name=association.main,Values=true" \
          --query 'RouteTables[0].RouteTableId' --output text 2>/dev/null)"
  fi
  if [ -z "$rtb" ] || [ "$rtb" = "None" ]; then
    printf "SKIPPED\t%s\t%s\n" "$region" "$iid" >> "$TMP_RES"
    return
  fi

  # Get route basics and decide public/private
  local routes is_public=0
  routes="$(aws ec2 describe-route-tables --region "$region" --route-table-ids "$rtb" \
           --query 'RouteTables[].Routes[].{gw:GatewayId,dst:DestinationCidrBlock}' \
           --output text 2>/dev/null)"
  echo "$routes" | grep -qE '(^|[[:space:]])igw-[a-z0-9]+' && is_public=1
  echo "$routes" | grep -q '0.0.0.0/0' && is_public=1

  if [ "$is_public" -eq 1 ]; then
    printf "NOT_COMPLIANT\t%s\t%s\n" "$region" "$iid" >> "$TMP_RES"
  else
    printf "COMPLIANT\t%s\t%s\n" "$region" "$iid" >> "$TMP_RES"
  fi
}

# -------- Launch workers + live progress --------
{
  # progress loop
  local done_prev=-1 done_now=0
  while :; do
    done_now="$(wc -l < "$TMP_RES" 2>/dev/null | tr -d ' ')"
    [ -z "$done_now" ] && done_now=0
    if [ "$done_now" -ne "$done_prev" ]; then
      draw_progress "$done_now" "$TOTAL"
      done_prev="$done_now"
    fi
    [ "$done_now" -ge "$TOTAL" ] && break
    sleep 0.2
  done
  echo
} & PROG_PID=$!

# Queue jobs
while IFS=$'\t' read -r region iid subnet vpc; do
  # acquire token
  read -r -u 3
  {
    check_one "$region" "$iid" "$subnet" "$vpc"
    # return token
    echo >&3
  } &
done < "$TMP_INST"

# Wait for all workers
wait
# Wait progress to finish drawing
wait "$PROG_PID" 2>/dev/null || true

# -------- Aggregate counts --------
COMPLIANT_COUNT="$(awk -F'\t' '$1=="COMPLIANT"{c++} END{print c+0}' "$TMP_RES")"
NOT_COUNT="$(awk -F'\t'      '$1=="NOT_COMPLIANT"{c++} END{print c+0}' "$TMP_RES")"
SKIPPED_COUNT="$(awk -F'\t'  '$1=="SKIPPED"{c++} END{print c+0}' "$TMP_RES")"
CHECKED=$(( COMPLIANT_COUNT + NOT_COUNT ))

pct(){ awk -v n="$1" -v d="$2" 'BEGIN{ if (d==0) printf "0.0"; else printf "%.1f", (n*100.0)/d }'; }

hr
echo "${BOLD}Summary${RESET}"
printf "Total instances  : %s\n" "$TOTAL"
printf "Checked          : %s\n" "$CHECKED"
printf "  ${GREEN}Compliant${RESET}       : %s (%s%%)\n" "$COMPLIANT_COUNT" "$(pct "$COMPLIANT_COUNT" "$CHECKED")"
printf "  ${RED}Not compliant${RESET}    : %s (%s%%)\n" "$NOT_COUNT" "$(pct "$NOT_COUNT" "$CHECKED")"
printf "Skipped          : %s\n" "$SKIPPED_COUNT"
hr
echo "${DIM}Rule: NOT_COMPLIANT if RouteTable has igw-* or 0.0.0.0/0; otherwise COMPLIANT.${RESET}"
