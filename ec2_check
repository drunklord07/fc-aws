#!/usr/bin/env bash
# EC2 Public Subnet Audit (parallel + progress bar; AWS CLI only)
# Rule: NOT_COMPLIANT if subnet's route table has igw-* OR 0.0.0.0/0; else COMPLIANT.
# Output: summary counts (no per-instance prints).

export AWS_PAGER=""

# ---- Colors & helpers ----
BOLD=$'\033[1m'; DIM=$'\033[2m'; RESET=$'\033[0m'
GREEN=$'\033[32m'; RED=$'\033[31m'; YELLOW=$'\033[33m'

hr() {
  cols=$(tput cols 2>/dev/null || echo 80)
  printf '%*s\n' "$cols" '' | tr ' ' '-'
}
need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing dependency: $1"; exit 1; }; }
need aws
need awk

# ---- Workers (override with: JOBS=24 ./ec2_check.sh ...) ----
JOBS="${JOBS:-16}"
case "$JOBS" in
  (''|*[!0-9]*) JOBS=16;;
esac
[ "$JOBS" -lt 1 ] && JOBS=1

# ---- Region selection ----
REGION_ARG="${1:-}"
if [ "$REGION_ARG" = "--all" ]; then
  REGIONS="$(aws ec2 describe-regions --query 'Regions[].RegionName' --output text 2>/dev/null)"
elif [ -n "$REGION_ARG" ]; then
  REGIONS="$REGION_ARG"
else
  DEFREG="$(aws configure get region 2>/dev/null || true)"
  if [ -n "$DEFREG" ]; then REGIONS="$DEFREG"
  else REGIONS="$(aws ec2 describe-regions --query 'Regions[].RegionName' --output text 2>/dev/null)"
  fi
fi
[ -z "$REGIONS" ] && { echo "No regions resolved. Set a default region or pass one/--all."; exit 1; }

ACCOUNT="$(aws sts get-caller-identity --query 'Account' --output text 2>/dev/null || echo UNKNOWN)"
ARN="$(aws sts get-caller-identity --query 'Arn' --output text 2>/dev/null || echo UNKNOWN)"

# ---- Temp files ----
TMP_INST="$(mktemp -t ec2_inst.XXXXXX)"
TMP_RES="$(mktemp -t ec2_res.XXXXXX)"
trap 'rm -f "$TMP_INST" "$TMP_RES" 2>/dev/null || true' EXIT

# ---- Collect instances (region, iid, subnet, vpc) ----
for REGION in $REGIONS; do
  aws ec2 describe-instances --region "$REGION" \
    --query 'Reservations[].Instances[].[InstanceId, SubnetId, VpcId]' \
    --output text 2>/dev/null \
    | awk -v r="$REGION" 'NF{ printf "%s\t%s\t%s\t%s\n", r,$1,$2,$3 }' >> "$TMP_INST"
done

TOTAL="$(wc -l < "$TMP_INST" 2>/dev/null | tr -d ' ')"
[ -z "$TOTAL" ] && TOTAL=0

echo
echo "${BOLD}EC2 Public Subnet Audit${RESET}"
echo "Account: ${BOLD}$ACCOUNT${RESET}"
echo "Caller : ${DIM}$ARN${RESET}"
echo "Regions: ${BOLD}$REGIONS${RESET}"
hr

if [ "$TOTAL" -eq 0 ]; then
  echo "${YELLOW}No EC2 instances found (or no permission) in the selected scope.${RESET}"
  hr
  echo "${BOLD}Summary${RESET}"
  printf "Total instances  : 0\nChecked          : 0\n  ${GREEN}Compliant${RESET}       : 0 (0.0%%)\n  ${RED}Not compliant${RESET}    : 0 (0.0%%)\nSkipped          : 0\n"
  hr
  echo "${DIM}Rule: NOT_COMPLIANT if RouteTable has igw-* or 0.0.0.0/0; otherwise COMPLIANT.${RESET}"
  exit 0
fi

# ---- Progress bar ----
draw_progress() {
  # args: done total
  done_amt="$1"
  total_amt="$2"
  cols=$(tput cols 2>/dev/null || echo 80)
  barw=$(( cols - 36 ))
  if [ "$barw" -lt 10 ]; then barw=10; fi
  if [ "$total_amt" -gt 0 ]; then
    filled=$(( done_amt * barw / total_amt ))
  else
    filled=0
  fi
  if [ "$filled" -lt 0 ]; then filled=0; fi
  if [ "$filled" -gt "$barw" ]; then filled="$barw"; fi
  empty=$(( barw - filled ))
  if [ "$total_amt" -gt 0 ]; then
    pct=$(( done_amt * 100 / total_amt ))
  else
    pct=0
  fi
  printf "\rProcessing: ["
  i=0; while [ $i -lt $filled ]; do printf "#"; i=$((i+1)); done
  i=0; while [ $i -lt $empty  ]; do printf "-"; i=$((i+1)); done
  printf "] %3d%% (%d/%d)" "$pct" "$done_amt" "$total_amt"
}

progress_loop() {
  # args: res_file total
  res_file="$1"
  total_amt="$2"
  done_prev=-1
  done_now=0
  while :; do
    done_now="$(wc -l < "$res_file" 2>/dev/null | tr -d ' ')"
    [ -z "$done_now" ] && done_now=0
    if [ "$done_now" -ne "$done_prev" ]; then
      draw_progress "$done_now" "$total_amt"
      done_prev="$done_now"
    fi
    if [ "$done_now" -ge "$total_amt" ]; then break; fi
    sleep 0.2
  done
  echo
}

# ---- Semaphore for parallelism (Bash 3 compatible) ----
SEM="$(mktemp -u)"; mkfifo "$SEM" || { echo "mkfifo failed"; exit 1; }
exec 3<>"$SEM"; rm -f "$SEM"
k=0; while [ $k -lt "$JOBS" ]; do echo >&3; k=$((k+1)); done

# ---- Worker: check one instance ----
check_one() {
  region="$1"; iid="$2"; subnet="$3"; vpc="$4"

  # No subnet â‡’ skipped
  if [ -z "$subnet" ] || [ "$subnet" = "None" ]; then
    printf "SKIPPED\t%s\t%s\n" "$region" "$iid" >> "$TMP_RES"
    return
  fi

  # Route table for subnet; else VPC main
  rtb="$(aws ec2 describe-route-tables --region "$region" \
        --filters "Name=association.subnet-id,Values=$subnet" \
        --query 'RouteTables[0].RouteTableId' --output text 2>/dev/null)"
  if [ -z "$rtb" ] || [ "$rtb" = "None" ]; then
    rtb="$(aws ec2 describe-route-tables --region "$region" \
          --filters "Name=vpc-id,Values=$vpc" "Name=association.main,Values=true" \
          --query 'RouteTables[0].RouteTableId' --output text 2>/dev/null)"
  fi
  if [ -z "$rtb" ] || [ "$rtb" = "None" ]; then
    printf "SKIPPED\t%s\t%s\n" "$region" "$iid" >> "$TMP_RES"
    return
  fi

  routes="$(aws ec2 describe-route-tables --region "$region" --route-table-ids "$rtb" \
           --query 'RouteTables[].Routes[].{gw:GatewayId,dst:DestinationCidrBlock}' \
           --output text 2>/dev/null)"

  is_public=0
  echo "$routes" | grep -qE '(^|[[:space:]])igw-[a-z0-9]+' && is_public=1
  echo "$routes" | grep -q '0.0.0.0/0' && is_public=1

  if [ "$is_public" -eq 1 ]; then
    printf "NOT_COMPLIANT\t%s\t%s\n" "$region" "$iid" >> "$TMP_RES"
  else
    printf "COMPLIANT\t%s\t%s\n" "$region" "$iid" >> "$TMP_RES"
  fi
}

# ---- Start progress and workers ----
progress_loop "$TMP_RES" "$TOTAL" & PROG_PID=$!

# Queue jobs
while IFS=$'\t' read -r region iid subnet vpc; do
  # acquire token
  read -r -u 3
  {
    check_one "$region" "$iid" "$subnet" "$vpc"
    # return token
    echo >&3
  } &
done < "$TMP_INST"

# Wait for all jobs & progress
wait
wait "$PROG_PID" 2>/dev/null || true

# ---- Aggregate counts ----
COMPLIANT_COUNT="$(awk -F'\t' '$1=="COMPLIANT"{c++} END{print c+0}' "$TMP_RES")"
NOT_COUNT="$(awk -F'\t'      '$1=="NOT_COMPLIANT"{c++} END{print c+0}' "$TMP_RES")"
SKIPPED_COUNT="$(awk -F'\t'  '$1=="SKIPPED"{c++} END{print c+0}' "$TMP_RES")"
CHECKED=$(( COMPLIANT_COUNT + NOT_COUNT ))

pct() { awk -v n="$1" -v d="$2" 'BEGIN{ if (d==0) printf "0.0"; else printf "%.1f", (n*100.0)/d }'; }

hr
echo "${BOLD}Summary${RESET}"
printf "Total instances  : %s\n" "$TOTAL"
printf "Checked          : %s\n" "$CHECKED"
printf "  ${GREEN}Compliant${RESET}       : %s (%s%%)\n" "$COMPLIANT_COUNT" "$(pct "$COMPLIANT_COUNT" "$CHECKED")"
printf "  ${RED}Not compliant${RESET}    : %s (%s%%)\n" "$NOT_COUNT" "$(pct "$NOT_COUNT" "$CHECKED")"
printf "Skipped          : %s\n" "$SKIPPED_COUNT"
hr
echo "${DIM}Rule: NOT_COMPLIANT if RouteTable has igw-* or 0.0.0.0/0; otherwise COMPLIANT.${RESET}"
