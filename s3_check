#!/usr/bin/env bash
# Audit: Detect S3 buckets with public WRITE ACL (AllUsers -> WRITE)
# Uses default AWS CLI credentials. Parallel, with a live progress bar + summary.

# -------- Config --------
CONCURRENCY="${CONCURRENCY:-8}"     # Change with: CONCURRENCY=16 bash script.sh

# -------- Setup --------
set -u
TMP_DIR="$(mktemp -d 2>/dev/null || mktemp -d -t s3audit)"
RESULT_DIR="$TMP_DIR/out"
ERR_DIR="$TMP_DIR/err"
PROG_FIFO="$TMP_DIR/prog.fifo"
TABLE_TSV="$TMP_DIR/table.tsv"
RESULTS_TSV="$TMP_DIR/results.tsv"
BUCKETS_TXT="$TMP_DIR/buckets.txt"
QUERY_ALLUSERS="Grants[?Grantee.URI=='http://acs.amazonaws.com/groups/global/AllUsers'].Permission"

mkdir -p "$RESULT_DIR" "$ERR_DIR"
trap 'tput cnorm 2>/dev/null || true; rm -rf "$TMP_DIR"' EXIT
tput civis 2>/dev/null || true

# -------- List buckets --------
if ! aws s3api list-buckets --query 'Buckets[].Name' --output text >"$BUCKETS_TXT" 2>"$TMP_DIR/_list_err.txt"; then
  tput cnorm 2>/dev/null || true
  echo "ERROR: Failed to list buckets."
  sed -n '1,10p' "$TMP_DIR/_list_err.txt"
  exit 1
fi

tr '\t' '\n' < "$BUCKETS_TXT" | sed '/^$/d' > "$TMP_DIR/_buckets_clean.txt"
mv "$TMP_DIR/_buckets_clean.txt" "$BUCKETS_TXT"

TOTAL="$(wc -l < "$BUCKETS_TXT" | tr -d ' ')"
if [ "$TOTAL" -eq 0 ]; then
  tput cnorm 2>/dev/null || true
  echo "No S3 buckets found."
  exit 0
fi

# -------- Progress monitor --------
mkfifo "$PROG_FIFO"

progress_monitor() {
  TOTAL="$1"; FIFO="$2"; COMPLETED=0; WIDTH=40
  while IFS= read -r _; do
    COMPLETED=$((COMPLETED+1))
    (( TOTAL == 0 )) && TOTAL=1
    DONE=$((COMPLETED*WIDTH/TOTAL))
    REM=$((WIDTH-DONE))
    HASHES="$(printf "%0.s#" $(seq 1 $DONE))"
    DOTS="$(printf "%0.s." $(seq 1 $REM))"
    PCT=$((COMPLETED*100/TOTAL))
    printf "\rProgress: [%s%s] %3d%% (%d/%d)" "$HASHES" "$DOTS" "$PCT" "$COMPLETED" "$TOTAL"
  done < "$FIFO"
  printf "\n"
}
progress_monitor "$TOTAL" "$PROG_FIFO" &
PROG_PID=$!

# -------- Concurrency capability --------
if ! printf "" | xargs -P 2 echo >/dev/null 2>&1; then
  CONCURRENCY=1
fi

# -------- Worker launcher --------
export QUERY_ALLUSERS RESULT_DIR ERR_DIR PROG_FIFO
xargs -P "$CONCURRENCY" -I {} bash -c '
  bucket="$1"
  # Query AllUsers permissions for this bucket
  perm="$(aws s3api get-bucket-acl \
            --bucket "$bucket" \
            --query "$QUERY_ALLUSERS" \
            --output text 2>"$ERR_DIR/$bucket.err")"
  rc=$?

  if [ $rc -ne 0 ]; then
    status="ERROR"
    perm=""
  else
    # perm may be empty or contain tokens like: READ WRITE FULL_CONTROL READ_ACP WRITE_ACP
    if echo "$perm" | grep -qw WRITE; then
      status="NONCOMPLIANT"
    else
      status="COMPLIANT"
    fi
  fi

  printf "%s\t%s\t%s\n" "$bucket" "$status" "$perm" > "$RESULT_DIR/$bucket.tsv"

  # IMPORTANT: write a *line* so progress monitor advances
  printf "1\n" > "$PROG_FIFO"
' _ {} < "$BUCKETS_TXT"

# -------- Finish progress --------
wait "$PROG_PID" 2>/dev/null || true
tput cnorm 2>/dev/null || true

# -------- Aggregate + print table --------
cat "$RESULT_DIR"/*.tsv > "$RESULTS_TSV"

COMPLIANT_COUNT=$(grep -c $'\tCOMPLIANT\t' "$RESULTS_TSV" 2>/dev/null || echo 0)
NONCOMPLIANT_COUNT=$(grep -c $'\tNONCOMPLIANT\t' "$RESULTS_TSV" 2>/dev/null || echo 0)
ERROR_COUNT=$(grep -c $'\tERROR\t' "$RESULTS_TSV" 2>/dev/null || echo 0)
CHECKED=$((COMPLIANT_COUNT + NONCOMPLIANT_COUNT + ERROR_COUNT))

{
  printf "BUCKET\tSTATUS\tALLUSERS_PERMISSIONS\n"
  cat "$RESULTS_TSV"
} > "$TABLE_TSV"

echo
echo "S3 Bucket ACL Audit (AllUsers â†’ WRITE exposure)"
echo "------------------------------------------------"
if command -v column >/dev/null 2>&1; then
  column -t -s $'\t' "$TABLE_TSV"
else
  cat "$TABLE_TSV"
fi

# -------- Summary --------
echo
echo "Summary"
echo "-------"
printf "Total buckets discovered           : %d\n" "$TOTAL"
printf "Checked (processed)                : %d\n" "$CHECKED"
printf "Compliant                          : %d\n" "$COMPLIANT_COUNT"
printf "Non-compliant (public WRITE)       : %d\n" "$NONCOMPLIANT_COUNT"
printf "Errors                              : %d\n" "$ERROR_COUNT"
printf "Skipped                             : %d\n" 0

if [ "$NONCOMPLIANT_COUNT" -gt 0 ]; then
  echo
  echo "Non-compliant buckets (public WRITE detected):"
  awk -F'\t' '$2=="NONCOMPLIANT"{print " - " $1}' "$RESULTS_TSV" | sort
fi

if [ "$ERROR_COUNT" -gt 0 ]; then
  echo
  echo "Errors (first line per bucket):"
  while IFS= read -r b; do
    if grep -q "^${b}"$'\tERROR\t' "$RESULTS_TSV"; then
      printf " - %s: " "$b"
      sed -n '1p' "$ERR_DIR/$b.err"
    fi
  done < <(ls -1 "$ERR_DIR"/*.err 2>/dev/null | xargs -r -n1 basename | sed 's/\.err$//')
fi

exit 0
