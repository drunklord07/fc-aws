#!/usr/bin/env bash
# Minimal EC2 public-subnet audit (IPv4 only). Requires AWS CLI.
# Output: region,instance_id,subnet_id,route_table_id,status

set -euo pipefail

PROFILE="default"

# Verify profile exists
aws configure list-profiles | grep -qx "$PROFILE" || {
  echo "ERROR: AWS profile '$PROFILE' not found." >&2
  exit 1
}

# CSV header
echo "region,instance_id,subnet_id,route_table_id,status"

# All regions
for REGION in $(aws ec2 describe-regions --profile "$PROFILE" --query 'Regions[].RegionName' --output text); do
  # InstanceId SubnetId VpcId (only running)
  aws ec2 describe-instances \
    --region "$REGION" --profile "$PROFILE" \
    --query 'Reservations[].Instances[?State.Name==`running`].[InstanceId,SubnetId,VpcId]' \
    --output text \
  | while read -r INSTANCE_ID SUBNET_ID VPC_ID; do
      # Route table associated to subnet
      RTB_ID=$(aws ec2 describe-route-tables \
        --region "$REGION" --profile "$PROFILE" \
        --filters "Name=association.subnet-id,Values=$SUBNET_ID" \
        --query 'RouteTables[0].RouteTableId' --output text 2>/dev/null || true)

      # Fallback to VPC main route table if none
      if [ -z "${RTB_ID:-}" ] || [ "$RTB_ID" = "None" ]; then
        RTB_ID=$(aws ec2 describe-route-tables \
          --region "$REGION" --profile "$PROFILE" \
          --filters "Name=vpc-id,Values=$VPC_ID" "Name=association.main,Values=true" \
          --query 'RouteTables[0].RouteTableId' --output text 2>/dev/null || true)
      fi

      # Determine compliance: default route (0.0.0.0/0) to an Internet Gateway => NON_COMPLIANT
      STATUS="UNKNOWN"
      if [ -n "${RTB_ID:-}" ] && [ "$RTB_ID" != "None" ]; then
        IGW_TEXT=$(aws ec2 describe-route-tables \
          --region "$REGION" --profile "$PROFILE" \
          --route-table-ids "$RTB_ID" \
          --query "RouteTables[].Routes[?DestinationCidrBlock=='0.0.0.0/0' && contains(GatewayId, 'igw-')]" \
          --output text 2>/dev/null || true)
        if [ -n "$IGW_TEXT" ]; then
          STATUS="NON_COMPLIANT"   # public subnet via IGW
        else
          STATUS="COMPLIANT"
        fi
      fi

      echo "$REGION,$INSTANCE_ID,$SUBNET_ID,${RTB_ID:-},$STATUS"
    done
done
